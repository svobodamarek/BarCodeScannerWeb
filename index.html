<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Search</title>
    <script src="https://cdn.apple-cloudkit.com/ck/2/cloudkit.js"></script>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f7;
        }
        h1 { text-align: center; color: #1d1d1f; }
        #login-section, #search-section, #results-section, #detail-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        #login-section { text-align: center; }
        .hidden { display: none !important; }
        input[type="text"] {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            font-size: 16px;
        }
        button {
            background: #0071e3;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin: 8px 4px 8px 0;
        }
        button:hover { background: #0077ed; }
        button.secondary { background: #86868b; }
        .result-item {
            padding: 12px;
            border-bottom: 1px solid #e5e5e5;
            cursor: pointer;
        }
        .result-item:hover { background: #f5f5f7; }
        .result-item:last-child { border-bottom: none; }
        .product-name { font-weight: 600; color: #1d1d1f; }
        .product-gtin { color: #86868b; font-size: 14px; }
        .detail-row {
            display: flex;
            padding: 8px 0;
            border-bottom: 1px solid #e5e5e5;
        }
        .detail-label { width: 150px; font-weight: 600; color: #86868b; }
        .detail-value { flex: 1; color: #1d1d1f; }
        .nutrition-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        .nutrition-item {
            background: #f5f5f7;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }
        .nutrition-value { font-size: 24px; font-weight: 600; color: #1d1d1f; }
        .nutrition-label { font-size: 12px; color: #86868b; }
        #user-info { color: #86868b; }
        .loading { text-align: center; padding: 20px; color: #86868b; }
        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        #appleid-signin {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>Product Search</h1>

    <div id="login-section">
        <p>Sign in with your iCloud account to search products</p>
        <div id="apple-sign-in-button"></div>
    </div>

    <div id="search-section" class="hidden">
        <div class="header-row">
            <div id="user-info"></div>
            <div id="apple-sign-out-button"></div>
        </div>
        <input type="text" id="gtin-input" placeholder="Search by GTIN (barcode)">
        <input type="text" id="name-input" placeholder="Search by product name">
        <button onclick="searchByGTIN()">Search GTIN</button>
        <button onclick="searchByName()">Search Name</button>
    </div>

    <div id="results-section" class="hidden">
        <h3>Results</h3>
        <div id="results-list"></div>
    </div>

    <div id="detail-section" class="hidden">
        <button class="secondary" onclick="hideDetail()">‚Üê Back to Results</button>
        <h3 id="detail-title"></h3>
        <div id="detail-content"></div>
    </div>

    <script>
        const CONTAINER_ID = 'iCloud.io.code.BarCodeScanner.common';
        const API_TOKEN = '1b808511f45736b673efd61d973092a8b67c044d880104a82295a97d9d52cd5d';

        let container, publicDB;

        // Initialize CloudKit
        CloudKit.configure({
            containers: [{
                containerIdentifier: CONTAINER_ID,
                apiTokenAuth: {
                    apiToken: API_TOKEN,
                    persist: true,
                    signInButton: {
                        id: 'apple-sign-in-button',
                        theme: 'black'
                    },
                    signOutButton: {
                        id: 'apple-sign-out-button',
                        theme: 'black'
                    }
                },
                environment: 'development'
            }]
        });

        container = CloudKit.getDefaultContainer();
        publicDB = container.publicCloudDatabase;

        // Set up CloudKit authentication
        function setupAuth() {
            container.setUpAuth().then(function(userIdentity) {
                if (userIdentity) {
                    onSignedIn(userIdentity);
                } else {
                    onSignedOut();
                }
            });
        }

        function onSignedIn(userIdentity) {
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('search-section').classList.remove('hidden');

            var displayName = 'Signed in';
            if (userIdentity.nameComponents) {
                var nc = userIdentity.nameComponents;
                displayName = ((nc.givenName || '') + ' ' + (nc.familyName || '')).trim();
            }
            if (!displayName || displayName === 'Signed in') {
                displayName = userIdentity.lookupInfo ? userIdentity.lookupInfo.emailAddress : 'Signed in';
            }
            document.getElementById('user-info').textContent = displayName || 'Signed in';
        }

        function onSignedOut() {
            document.getElementById('login-section').classList.remove('hidden');
            document.getElementById('search-section').classList.add('hidden');
            document.getElementById('results-section').classList.add('hidden');
            document.getElementById('detail-section').classList.add('hidden');
        }

        function signOut() {
            container.whenUserSignsOut().then(function() {
                onSignedOut();
            });
        }

        // Initialize auth on page load
        setupAuth();

        var desiredKeys = ['name', 'gtin', 'venueID', 'countryOfOrigin', 'ingredients',
            'allergens', 'energyKJ', 'energyKcal', 'fat', 'saturatedFat', 'carbohydrates',
            'sugars', 'fiber', 'protein', 'salt', 'storageInstructions', 'manufacturer'];

        function searchByGTIN() {
            var gtin = document.getElementById('gtin-input').value.trim();
            if (!gtin) { alert('Please enter a GTIN'); return; }

            // Pad with leading zeros to 14 digits
            var paddedGtin = gtin.padStart(14, '0');
            console.log('Searching for GTIN:', gtin, '-> padded:', paddedGtin);

            document.getElementById('results-section').classList.remove('hidden');
            document.getElementById('detail-section').classList.add('hidden');
            document.getElementById('results-list').innerHTML = '<div class="loading">Searching...</div>';

            // Run two parallel queries: raw input and zero-padded input
            var query1 = {
                recordType: 'Product',
                filterBy: [{ fieldName: 'gtin', comparator: 'BEGINS_WITH', fieldValue: { value: gtin } }],
                desiredKeys: desiredKeys,
                resultsLimit: 50
            };
            var query2 = {
                recordType: 'Product',
                filterBy: [{ fieldName: 'gtin', comparator: 'BEGINS_WITH', fieldValue: { value: paddedGtin } }],
                desiredKeys: desiredKeys,
                resultsLimit: 50
            };

            Promise.all([
                publicDB.performQuery(query1),
                publicDB.performQuery(query2)
            ]).then(function(responses) {
                console.log('CloudKit GTIN responses:', responses);

                // Check for errors
                for (var i = 0; i < responses.length; i++) {
                    if (responses[i].hasErrors) {
                        console.error('CloudKit errors:', responses[i].errors);
                        document.getElementById('results-list').innerHTML =
                            '<div class="loading">Error: ' + responses[i].errors[0].reason + '</div>';
                        return;
                    }
                }

                // Merge and deduplicate results
                var seenIds = {};
                var mergedRecords = [];
                for (var r = 0; r < responses.length; r++) {
                    var records = responses[r].records;
                    for (var j = 0; j < records.length; j++) {
                        var record = records[j];
                        var recordName = record.recordName;
                        if (!seenIds[recordName]) {
                            seenIds[recordName] = true;
                            mergedRecords.push(record);
                        }
                    }
                }

                if (mergedRecords.length === 0) {
                    document.getElementById('results-list').innerHTML =
                        '<div class="loading">No products found</div>';
                    return;
                }

                window.searchResults = mergedRecords;
                displayResults(mergedRecords, false, false);
            });
        }

        function searchByName() {
            var name = document.getElementById('name-input').value.trim();
            if (!name) { alert('Please enter a product name'); return; }
            console.log('Searching for name:', name);
            performSearch({
                recordType: 'Product',
                filterBy: [{ fieldName: 'name', comparator: 'BEGINS_WITH', fieldValue: { value: name } }],
                desiredKeys: desiredKeys
            }, 50);
        }

        function fetchAll() {
            // Debug function - fetch first 20 records without filters
            performSearch({
                recordType: 'Product',
                desiredKeys: desiredKeys
            }, 20);
        }

        var currentQuery = null;
        var continuationMarker = null;

        function performSearch(query, limit) {
            currentQuery = query;
            continuationMarker = null;
            if (limit) query.resultsLimit = limit;

            document.getElementById('results-section').classList.remove('hidden');
            document.getElementById('detail-section').classList.add('hidden');
            document.getElementById('results-list').innerHTML = '<div class="loading">Searching...</div>';

            executeQuery(query, false);
        }

        function loadMore() {
            if (!continuationMarker || !currentQuery) return;
            var query = Object.assign({}, currentQuery);
            query.continuationMarker = continuationMarker;
            executeQuery(query, true);
        }

        function displayResults(records, append, showLoadMore) {
            var startIndex = append ? window.searchResults.length : 0;

            var html = '';
            for (var i = 0; i < records.length; i++) {
                var record = records[i];
                var fields = record.fields;
                var name = fields.name ? fields.name.value : 'Unknown';
                var gtin = fields.gtin ? fields.gtin.value : '';
                html += '<div class="result-item" data-index="' + (startIndex + i) + '">' +
                    '<div class="product-name">' + escapeHtml(name) + '</div>' +
                    '<div class="product-gtin">' + escapeHtml(gtin) + '</div></div>';
            }

            if (showLoadMore) {
                html += '<button class="secondary" style="width:100%;margin-top:10px" onclick="loadMore()">Load More...</button>';
            }

            if (append) {
                var list = document.getElementById('results-list');
                var oldBtn = list.querySelector('button');
                if (oldBtn) oldBtn.remove();
                list.insertAdjacentHTML('beforeend', html);
            } else {
                document.getElementById('results-list').innerHTML = html;
            }

            var items = document.querySelectorAll('.result-item');
            for (var j = 0; j < items.length; j++) {
                items[j].onclick = function() {
                    var idx = parseInt(this.getAttribute('data-index'));
                    showDetail(window.searchResults[idx]);
                };
            }
        }

        function executeQuery(query, append) {
            publicDB.performQuery(query).then(function(response) {
                console.log('CloudKit response:', response);
                if (response.hasErrors) {
                    console.error('CloudKit errors:', response.errors);
                    document.getElementById('results-list').innerHTML =
                        '<div class="loading">Error: ' + response.errors[0].reason + '</div>';
                    return;
                }

                var records = response.records;
                continuationMarker = response.continuationMarker;

                if (records.length === 0 && !append) {
                    document.getElementById('results-list').innerHTML =
                        '<div class="loading">No products found</div>';
                    return;
                }

                if (append) {
                    window.searchResults = window.searchResults.concat(records);
                } else {
                    window.searchResults = records;
                }

                displayResults(records, append, !!continuationMarker);
            });
        }

        function showDetail(record) {
            document.getElementById('results-section').classList.add('hidden');
            document.getElementById('detail-section').classList.remove('hidden');

            var fields = record.fields;
            var name = fields.name ? fields.name.value : 'Unknown Product';
            document.getElementById('detail-title').textContent = name;

            var html = '';
            html += detailRow('GTIN', fields.gtin);
            html += detailRow('Venue ID', fields.venueID);
            html += detailRow('Country', fields.countryOfOrigin);
            html += detailRow('Manufacturer', fields.manufacturer);
            html += detailRow('Ingredients', fields.ingredients);
            html += detailRow('Allergens', fields.allergens);
            html += detailRow('Storage', fields.storageInstructions);

            html += '<h4>Nutrition (per 100g)</h4><div class="nutrition-grid">';
            html += nutritionItem(fields.energyKcal, 'Energy', 'kcal');
            html += nutritionItem(fields.energyKJ, 'Energy', 'kJ');
            html += nutritionItem(fields.fat, 'Fat', 'g');
            html += nutritionItem(fields.saturatedFat, 'Sat. Fat', 'g');
            html += nutritionItem(fields.carbohydrates, 'Carbs', 'g');
            html += nutritionItem(fields.sugars, 'Sugars', 'g');
            html += nutritionItem(fields.fiber, 'Fiber', 'g');
            html += nutritionItem(fields.protein, 'Protein', 'g');
            html += nutritionItem(fields.salt, 'Salt', 'g');
            html += '</div>';

            document.getElementById('detail-content').innerHTML = html;
        }

        function detailRow(label, field) {
            var value = field && field.value ? field.value : '-';
            return '<div class="detail-row"><div class="detail-label">' + label +
                   '</div><div class="detail-value">' + escapeHtml(value) + '</div></div>';
        }

        function nutritionItem(field, label, unit) {
            if (!field || field.value === undefined || field.value === null) return '';
            return '<div class="nutrition-item"><div class="nutrition-value">' +
                   field.value.toFixed(1) + '</div><div class="nutrition-label">' +
                   label + ' (' + unit + ')</div></div>';
        }

        function hideDetail() {
            document.getElementById('detail-section').classList.add('hidden');
            document.getElementById('results-section').classList.remove('hidden');
        }

        function escapeHtml(text) {
            if (!text) return '';
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
